- name: Deploy n8n to Cloud Run
  run: |
    gcloud run deploy n8n \
      --image=n8nio/n8n:latest \
      --command="/bin/sh" \
      --args="-c,sleep 5;n8n start" \
      --platform=managed \
      --region=${{ secrets.GCP_REGION }} \
      --project=${{ secrets.GCP_PROJECT_ID }} \
      --allow-unauthenticated \
      --port=5678 \
      --memory=2Gi \
      --no-cpu-throttling \
      --max-instances=1 \
      --set-env-vars=\
DB_TYPE=postgresdb,\
DB_POSTGRESDB_HOST=${{ secrets.NEON_HOST }},\
DB_POSTGRESDB_PORT=5432,\
DB_POSTGRESDB_DATABASE=n8n,\
DB_POSTGRESDB_USER=${{ secrets.NEON_USER }},\
DB_POSTGRESDB_SSL_ENABLED=true,\
DB_POSTGRESDB_SCHEMA=public,\
GENERIC_TIMEZONE=Asia/Jerusalem,\
QUEUE_HEALTH_CHECK_ACTIVE=true,\
N8N_HOST=${{ secrets.N8N_HOST }},\
N8N_PORT=5678,\
N8N_PROTOCOL=https \
      --set-secrets=DB_POSTGRESDB_PASSWORD=n8n-db-password:latest \
      --set-secrets=N8N_ENCRYPTION_KEY=n8n-encryption-key:latest \
      --quiet
