name: Deploy n8n to Cloud Run

# -------------------------------------------------
# When to run the workflow
# -------------------------------------------------
on:
  push:
    branches: [ main ]          # automatic on pushes to main
  workflow_dispatch:            # also allow manual runs from the UI

# -------------------------------------------------
# One job that does everything
# -------------------------------------------------
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read               # checkout
      id-token: write              # needed for OIDC token exchange (optional)

    env:
      PROJECT_ID:   ${{ secrets.GCP_PROJECT_ID }}
      REGION:       ${{ secrets.GCP_REGION }}
      SERVICE_NAME: n8n
      IMAGE:        n8nio/n8n:latest   # using the public n8n image

      # -------------------------------------------------
      # Environment variables that will be passed to the container
      # -------------------------------------------------
      DB_TYPE:                     postgresdb
      DB_POSTGRESDB_PORT:          5432
      DB_POSTGRESDB_DATABASE:      n8n
      DB_POSTGRESDB_USER:          ${{ secrets.NEON_USER }}
      DB_POSTGRESDB_SSL_ENABLED:   true
      DB_POSTGRESDB_SCHEMA:        public
      GENERIC_TIMEZONE:            Asia/Jerusalem
      QUEUE_HEALTH_CHECK_ACTIVE:  true
      N8N_PORT:                    5678
      N8N_PROTOCOL:                https

    steps:
      # -------------------------------------------------
      # 1️⃣ Checkout the repo (needed for the workflow itself)
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2️⃣ Authenticate to Google Cloud using the SA key
      # -------------------------------------------------
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # -------------------------------------------------
      # 3️⃣ Install the gcloud SDK (the auth action already did this)
      # -------------------------------------------------
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          
      # -------------------------------------------------
      # 4️⃣ Deploy to Cloud Run
      # -------------------------------------------------
      - name: Deploy n8n to Cloud Run
        run: |
          gcloud run deploy "${SERVICE_NAME}" \
            --image="${IMAGE}" \
            --command="/bin/sh" \
            --args="-c,sleep 10;n8n start" \
            --platform=managed \
            --region="${REGION}" \
            --project="${PROJECT_ID}" \
            --allow-unauthenticated \
            --port=5678 \
            --memory=2Gi \
            --no-cpu-throttling \
            --max-instances=1 \
            --set-env-vars="DB_TYPE=${DB_TYPE},\
                           DB_POSTGRESDB_PORT=${DB_POSTGRESDB_PORT},\
                           DB_POSTGRESDB_DATABASE=${DB_POSTGRESDB_DATABASE},\
                           DB_POSTGRESDB_USER=${DB_POSTGRESDB_USER},\
                           DB_POSTGRESDB_SSL_ENABLED=${DB_POSTGRESDB_SSL_ENABLED},\
                           DB_POSTGRESDB_SCHEMA=${DB_POSTGRESDB_SCHEMA},\
                           GENERIC_TIMEZONE=${GENERIC_TIMEZONE},\
                           QUEUE_HEALTH_CHECK_ACTIVE=${QUEUE_HEALTH_CHECK_ACTIVE},\
                           N8N_PORT=${N8N_PORT},\
                           N8N_PROTOCOL=${N8N_PROTOCOL}" \
            --set-secrets=DB_POSTGRESDB_PASSWORD=n8n-db-password:latest \
            --set-secrets=N8N_ENCRYPTION_KEY=n8n-encryption-key:latest \
            --set-secrets=DB_POSTGRESDB_HOST=DB_POSTGRESDB_HOST:latest \
            --set-secrets=N8N_HOST=N8N_HOST:latest \
            --quiet
