name: Deploy n8n to Cloud Run
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Deploy n8n to Cloud Run
        run: |
          gcloud run deploy n8n \
            --image=n8nio/n8n:latest \
            --platform=managed \
            --region=${{ secrets.GCP_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --allow-unauthenticated \
            --port=5678 \
            --memory=2Gi \
            --no-cpu-throttling \
            --max-instances=1 \
            --set-env-vars=DB_TYPE=postgresdb,DB_POSTGRESDB_CONNECTION_URL=postgresql://${{ secrets.NEON_USER }}:${{ secrets.NEON_PASSWORD }}@ep-muddy-glade-a406ettc-pooler.us-east-1.aws.neon.tech/n8n?sslmode=require,GENERIC_TIMEZONE=Asia/Jerusalem,QUEUE_HEALTH_CHECK_ACTIVE=true,N8N_HOST=${{ secrets.N8N_HOST }},N8N_PORT=5678,N8N_PROTOCOL=https,EXECUTIONS_MODE=queue,N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true \
            --set-secrets=N8N_ENCRYPTION_KEY=n8n-encryption-key:latest \
            --quiet
